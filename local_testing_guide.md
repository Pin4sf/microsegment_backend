# Local Development Testing Guide

This guide provides instructions on how to test the various features of the application on your local development machine.

## Prerequisites

Before you begin testing, ensure you have the following set up:

1.  **Working Application Setup:** The FastAPI application should be running locally as per the instructions in `README.md`. This includes setting up the `.env` file, database, and installing dependencies.
2.  **`ngrok`:** Install and configure `ngrok` to expose your local server (typically running on port 8000) to the internet. Example: `ngrok http 8000`. Note the public HTTPS URL ngrok provides.
3.  **Shopify Partner Account & Development Store:** You'll need a Shopify Partner account and a development store to install and test your app and extension.
4.  **Shopify CLI:** Install the [Shopify CLI](https://shopify.dev/docs/apps/tools/cli) and log in to your Partner account (`shopify login`).
5.  **API Request Tool:** A tool for making HTTP requests, such as [Postman](https://www.postman.com/) or `curl`, will be useful for testing API endpoints directly.

## Testing Web Pixel Extension Integration

This section covers how to test the web pixel extension functionality, from deployment to event tracking.

### 1. Deploy the Extension
- Navigate to the extension directory: `cd extensions/microsegments-activity-tracker`
- Ensure your Shopify CLI is connected to the correct Partner organization and development store.
- Deploy the extension:
    ```bash
    shopify extension push
    # Follow CLI prompts to create or update the extension
    # Then, to make it available as a draft or version:
    shopify extension deploy
    # Select your extension when prompted and choose a version tag.
    ```
- In your Shopify Partner Dashboard, navigate to your app, then "Extensions". Find "Microsegments Activity Tracker" and ensure it's active or create a new version pointing to your deployed extension. (The exact steps might vary slightly based on Shopify CLI versions and Partner Dashboard UI).
- Alternatively, after pushing, you might need to enable it on your development store through the app's listing in the store's "Apps" section or directly if it's a theme app extension.

### 2. Activate the Extension via API
- Once the app is installed on your dev store (OAuth flow completed), you need to activate our backend's record of the extension.
- Make a `POST` request to your app's `/api/v1/auth/shopify/activate-extension` endpoint.
    - **URL:** `YOUR_NGROK_URL/api/v1/auth/shopify/activate-extension`
    - **Method:** `POST`
    - **Headers:** `Content-Type: application/json`
    - **Body (JSON):**
      ```json
      {
        "shop": "your-dev-store.myshopify.com",
        "access_token": "YOUR_SHOP_ACCESS_TOKEN_FROM_DB_OR_INSTALL",
        "extension_settings": {
          // Initially, this can be empty as accountID is generated by backend if not provided.
          // "accountID": "your-desired-test-account-id" // Optional
        }
      }
      ```
    - **Response:** Note the `account_id` returned in the response. This ID is crucial for linking events. You should also see a `shopify_extension_id` (Shopify's GID for the web pixel).

### 3. Trigger Real Events on Your Dev Store
- Open your development store in a browser.
- Navigate to various pages (homepage, product pages, collections).
- Add products to the cart, view the cart.
- Open your browser's developer console (usually F12). In the "Console" tab, you should see messages from the Web Pixel API like `[WebPixel] Event: page_viewed published...` or similar, indicating that `shopifyAnalytics.publish(...)` calls are being made by the extension.
- These events are sent by Shopify to the endpoint configured when the web pixel was created by `activate-extension` (which is our app's `/api/v1/data/shopify/event` endpoint, though Shopify proxies this).

### 4. Simulate Event Ingestion (Direct API Call)
- To test the `/api/v1/data/shopify/event` endpoint directly without relying on the full browser-Shopify-backend flow, you can send a `POST` request:
    - **URL:** `YOUR_NGROK_URL/api/v1/data/shopify/event`
    - **Method:** `POST`
    - **Headers:** `Content-Type: application/json`
    - **Body (JSON):** Use the `account_id` obtained from the activation step.
      ```json
      {
        "account_id": "THE_ACCOUNT_ID_FROM_ACTIVATION_RESPONSE",
        "event_name": "page_viewed",
        "payload": {
          "test_event": true,
          "url": "/simulated-page",
          "timestamp": "2023-10-27T10:00:00Z"
        }
      }
      ```
- **Response:** You should get a `201 Created` response if the event is accepted.

### 5. Verify Event Storage
- Access your application's database.
- Query the `events` table to see if the new events (both from real browsing and simulated ingestion) are being recorded:
  ```sql
  SELECT * FROM events WHERE account_id = 'THE_ACCOUNT_ID_FROM_ACTIVATION_RESPONSE' ORDER BY received_at DESC;
  -- Or, if you know the shop_id:
  -- SELECT e.* FROM events e JOIN shops s ON e.shop_id = s.id WHERE s.shop_domain = 'your-dev-store.myshopify.com' ORDER BY e.received_at DESC;
  ```

### 6. Test Extension Status Endpoint
- Make a `GET` request to check the status of the extension for your shop:
    - **URL:** `YOUR_NGROK_URL/api/v1/auth/shopify/extension-status?shop_domain=your-dev-store.myshopify.com`
    - **Method:** `GET`
- **Response:** You should see details like the `account_id`, `status` ('active'), `shopify_extension_id`, etc.

## Testing Webhook Handlers

This section explains how to test the Shopify webhook handlers implemented in the application.

### 1. Expose Your Local App with `ngrok`
- Ensure `ngrok` is running and pointing to your local application's port (e.g., 8000).
  ```bash
  ngrok http 8000
  ```
- Note the HTTPS URL provided by `ngrok` (e.g., `https://your-unique-id.ngrok.io`). This will be referred to as `YOUR_NGROK_URL`.
- Your webhook callback URL, as configured in the app, will be `YOUR_NGROK_URL/webhooks`.

### 2. Webhook Auto-Registration
- When you install the app on your development store and complete the OAuth flow, the application automatically attempts to register the required webhooks (`CUSTOMERS_DATA_REQUEST`, `CUSTOMERS_REDACT`, `SHOP_REDACT`, `APP_UNINSTALLED`).
- Check your application logs during the OAuth callback process. You should see messages indicating the success or failure of these webhook registrations.
- You can also verify this in your Shopify Partner Dashboard under your app's settings (Webhooks section) or by querying the Shopify API for active webhooks for your dev store if needed.

### 3. Triggering Real GDPR Webhooks from Shopify Admin
These webhooks are triggered by actions within your development store's Shopify Admin interface. Your local application (exposed via ngrok) should receive these webhook POST requests.

- **`CUSTOMERS_DATA_REQUEST`**:
    1.  In your dev store's Shopify Admin, navigate to "Customers".
    2.  Select a customer.
    3.  Click on the "More actions" dropdown (or similar, UI may vary) and select "Request customer data".
    4.  Shopify will send a `customers/data_request` webhook to your app.
    5.  Check your application logs. The `handle_customers_data_request` function should log the compiled event data for this customer.

- **`CUSTOMERS_REDACT`**:
    1.  In your dev store's Shopify Admin, navigate to "Customers".
    2.  Select a customer.
    3.  Click on "More actions" and select "Erase personal data". Confirm the action.
    4.  Shopify will send a `customers/redact` webhook.
    5.  Check application logs. The `handle_customers_redact` function should log the redaction and associated events should be deleted from your `events` table. Verify this with a SQL query.

- **`SHOP_REDACT`**:
    1.  This webhook is typically sent when a merchant uninstalls your app and requests data deletion, or when Shopify processes a store closure.
    2.  **Testing App Uninstall:** The `APP_UNINSTALLED` webhook (which we also register) is usually sent first. You can test this by uninstalling your app from the dev store.
    3.  For `SHOP_REDACT` specifically, after uninstalling, you might need to go to your Shopify Partner Dashboard, find your app, and under "Distribution" (or a similar section for app settings), there might be a GDPR compliance section where you can initiate a "Shop Redaction Request" for your dev store. This process can be less straightforward for on-demand testing.
    4.  If triggered, check application logs. The `handle_shop_redact` function should log the action, delete all `events` and `extensions` for the shop, and nullify the shop's access token in the `shops` table.

### 4. Simulating Webhook Delivery (for Quicker Iteration)
For faster testing of handler logic without going through the Shopify Admin each time, you can simulate webhook delivery using `curl` or Postman.

- **Endpoint:** `YOUR_NGROK_URL/webhooks`
- **Method:** `POST`
- **Headers:**
    - `Content-Type: application/json`
    - `X-Shopify-Topic: <topic_name>` (e.g., `customers/data_request`)
    - `X-Shopify-Shop-Domain: your-dev-store.myshopify.com`
    - `X-Shopify-Hmac-Sha256: <hmac_value>`
        - **Note on HMAC:** Generating a valid HMAC for manual requests is complex as it requires using your app's shared secret. For local development and *trusted simulation only*, you might:
            - Temporarily modify the `verify_webhook` utility to bypass HMAC validation if a specific debug environment variable or flag is set. **This is a security risk and should NEVER be done in production.**
            - Focus on directly calling the handler functions (`handle_customers_data_request`, etc.) from a test script within your application if you want to unit-test the logic without the HTTP layer.
            - For these examples, we'll assume you're aware of the HMAC and might be testing with a temporarily bypassed verification for ease, or you're just checking if the request hits the endpoint.

- **Example Payloads:**

    - **`customers/data_request`**:
      ```bash
      curl -X POST YOUR_NGROK_URL/webhooks \
      -H "Content-Type: application/json" \
      -H "X-Shopify-Topic: customers/data_request" \
      -H "X-Shopify-Shop-Domain: your-dev-store.myshopify.com" \
      -H "X-Shopify-Hmac-Sha256: FAKED_FOR_TESTING" \
      -d '{
        "shop_id": 987654321,
        "shop_domain": "your-dev-store.myshopify.com",
        "customer": {
          "id": "gid://shopify/Customer/1234567890",
          "email": "customer@example.com"
        },
        "orders_requested": ["gid://shopify/Order/1122334455"]
      }'
      ```

    - **`customers/redact`**:
      ```bash
      curl -X POST YOUR_NGROK_URL/webhooks \
      -H "Content-Type: application/json" \
      -H "X-Shopify-Topic: customers/redact" \
      -H "X-Shopify-Shop-Domain: your-dev-store.myshopify.com" \
      -H "X-Shopify-Hmac-Sha256: FAKED_FOR_TESTING" \
      -d '{
        "shop_id": 987654321,
        "shop_domain": "your-dev-store.myshopify.com",
        "customer": {
          "id": "gid://shopify/Customer/1234567890",
          "email": "customer@example.com"
        },
        "orders_to_redact": ["gid://shopify/Order/1122334455"]
      }'
      ```

    - **`shop/redact`**:
      ```bash
      curl -X POST YOUR_NGROK_URL/webhooks \
      -H "Content-Type: application/json" \
      -H "X-Shopify-Topic: shop/redact" \
      -H "X-Shopify-Shop-Domain: your-dev-store.myshopify.com" \
      -H "X-Shopify-Hmac-Sha256: FAKED_FOR_TESTING" \
      -d '{
        "shop_id": 987654321,
        "shop_domain": "your-dev-store.myshopify.com"
      }'
      ```

### 5. Verification
- **Application Logs:** Check your local application's console output for logs from the webhook handlers. These logs should indicate which handler was triggered, the data received, and actions performed.
- **Database:**
    - For `customers/data_request`, no DB changes, but logs are key.
    - For `customers/redact`, verify that events related to the customer ID are deleted from the `events` table.
    - For `shop/redact`, verify that all `events` and `extensions` for the shop are deleted, and the `shops` table entry for the shop has its `access_token` nulled and `is_installed` set to `false`.

### General Webhook Testing Notes
-   **HMAC Verification:** Ensure your `SHOPIFY_API_SECRET` in your `.env` file matches the "API secret key" of your app in the Shopify Partner Dashboard. If not, HMAC validation will fail, and webhooks will be rejected with a 401 error.
-   **`ngrok` URL Stability:** If you restart `ngrok`, the public URL will change. You'll need to update your app's URL in the Shopify Partner Dashboard and potentially re-register webhooks (or the app might do this automatically on next OAuth if existing webhook URLs don't match). The current webhook registration logic *should* handle re-registering if the callback URL changes.
-   **Response Time:** Webhook handlers should respond quickly (within 5 seconds as per Shopify's recommendation) with a 200 OK. For longer tasks, use background job processing. The current handlers are designed to be quick by primarily logging or performing direct DB operations.
-   **`APP_UNINSTALLED` Webhook Testing:**
    -   **Trigger:** Uninstall your app from your development store's "Apps" section.
    -   **Verification:** Check application logs for receipt of the `app/uninstalled` topic. The current implementation registers this webhook but does not have a dedicated handler function beyond the generic acknowledgment. If specific actions are needed for `APP_UNINSTALLED` that differ from `SHOP_REDACT`, a specific handler would need to be implemented. Often, `SHOP_REDACT` (if triggered by Shopify or the merchant post-uninstall) serves as the primary data cleanup.
